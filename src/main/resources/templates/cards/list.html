<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>명함 목록 - 명함 매니저먼트 시스템</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<nav class="navbar">
    <div class="navbar-brand">명함 매니저먼트 시스템</div>
    <div class="navbar-menu">
        <a href="/cards/list">명함 목록</a>
        <a href="/cards/add">명함 추가</a>
        <a href="/cards/upload">엑셀 업로드</a>
        <a href="/cards/duplicates">중복 관리</a>
        <div class="navbar-user">
            <span th:text="${user.name} + '님'"></span>
            <a href="/logout">로그아웃</a>
        </div>
    </div>
</nav>

<div class="container">
    <!-- 통계 카드 -->
    <div class="stats-grid">
        <div class="stat-card">
            <h3>전체 명함</h3>
            <div class="value" th:text="${totalCount}">0</div>
            <div class="label">Total Cards</div>
        </div>
        <div class="stat-card">
            <h3>일반기업</h3>
            <div class="value" th:text="${categoryStats.get(T(com.demo.sms.card.entity.BusinessCard.Category).COMPANY) ?: 0}">0</div>
            <div class="label">Company</div>
        </div>
        <div class="stat-card">
            <h3>학교</h3>
            <div class="value" th:text="${categoryStats.get(T(com.demo.sms.card.entity.BusinessCard.Category).SCHOOL) ?: 0}">0</div>
            <div class="label">School</div>
        </div>
        <div class="stat-card">
            <h3>협회</h3>
            <div class="value" th:text="${categoryStats.get(T(com.demo.sms.card.entity.BusinessCard.Category).ASSOCIATION) ?: 0}">0</div>
            <div class="label">Association</div>
        </div>
        <div class="stat-card">
            <h3>관공서</h3>
            <div class="value" th:text="${categoryStats.get(T(com.demo.sms.card.entity.BusinessCard.Category).GOVERNMENT) ?: 0}">0</div>
            <div class="label">Government</div>
        </div>
    </div>

    <!-- 검색 영역 -->
    <div class="card">
        <h2>명함 검색</h2>
        <form class="search-form" th:action="@{/cards/list}" method="get">
            <div class="form-group">
                <label for="category">분류</label>
                <select id="category" name="category">
                    <option value="">전체</option>
                    <option th:each="cat : ${categories}"
                            th:value="${cat}"
                            th:text="${cat.displayName}"
                            th:selected="${cat == selectedCategory}"></option>
                </select>
            </div>

            <div class="form-group">
                <label for="searchField">검색 필드</label>
                <select id="searchField" name="searchField">
                    <option value="all" th:selected="${searchField == 'all' || searchField == null}">전체</option>
                    <option value="name" th:selected="${searchField == 'name'}">이름</option>
                    <option value="company" th:selected="${searchField == 'company'}">회사</option>
                    <option value="position" th:selected="${searchField == 'position'}">직함</option>
                    <option value="address" th:selected="${searchField == 'address'}">주소</option>
                </select>
            </div>

            <div class="form-group">
                <label for="keyword">검색어</label>
                <input type="text" id="keyword" name="keyword" th:value="${keyword}">
            </div>

            <button type="submit" class="btn btn-primary">검색</button>
            <a href="/cards/list" class="btn btn-secondary">초기화</a>
        </form>

        <div class="search-result-count">
            검색 결과: <strong th:text="${searchCount}">0</strong>개
        </div>
    </div>

    <div th:if="${success}" class="alert alert-success" th:utext="${success}"></div>
    <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

    <!-- 정렬 옵션 (검색 결과 위에 배치) -->
    <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
        <label style="font-weight: 500; margin: 0;">정렬:</label>
        <select id="sortBySelect" onchange="changeSortBy()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
            <option value="recent" th:selected="${sortBy == 'recent' || sortBy == null}">최근 저장순</option>
            <option value="oldest" th:selected="${sortBy == 'oldest'}">오래된순</option>
            <option value="name" th:selected="${sortBy == 'name'}">이름순 (ㄱ-ㅎ)</option>
        </select>
    </div>

    <!-- 액션 버튼 -->
    <div class="actions">
        <form th:action="@{/cards/download}" method="get" class="download-form">
            <input type="hidden" name="category" th:value="${selectedCategory}">
            <input type="hidden" name="keyword" th:value="${keyword}">
            <input type="hidden" name="searchField" th:value="${searchField}">
            <input type="hidden" name="sortBy" th:value="${sortBy}">
            <button type="submit" class="btn btn-success">엑셀 다운로드</button>
        </form>

        <!-- 이메일 다운로드 버튼 -->
        <button type="button" class="btn btn-info" onclick="showEmailDownloadModal()">
            이메일 다운로드
        </button>
    </div>

    <!-- 명함 목록 -->
    <div class="table-container">
        <table th:if="${!cards.isEmpty()}">
            <thead>
            <tr>
                <th>이름</th>
                <th>회사</th>
                <th>부서</th>
                <th>직함</th>
                <th>주소</th>
                <th>휴대폰</th>
                <th>이메일</th>
                <th>분류</th>
                <th>비고</th>
                <th>관리</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="card : ${cards}" th:attr="data-id=${card.id}" onclick="goToDetail(this)">
                <td th:text="${card.name}" th:title="${card.name}"></td>
                <td th:text="${card.company}" th:title="${card.company}"></td>
                <td th:text="${card.department}" th:title="${card.department}"></td>
                <td th:text="${card.position}" th:title="${card.position}"></td>
                <td th:text="${card.address}" th:title="${card.address}"></td>
                <td th:text="${card.mobilePhone}"></td>
                <td th:text="${card.email}" th:title="${card.email}"></td>
                <td>
                    <span th:class="'badge ' + ${card.category.name() == 'COMPANY' ? 'badge-company' :
                                   (card.category.name() == 'SCHOOL' ? 'badge-school' :
                                   (card.category.name() == 'ASSOCIATION' ? 'badge-association' : 'badge-government'))}"
                          th:text="${card.category.displayName}"></span>
                </td>
                <td th:text="${card.notes}" th:title="${card.notes}"></td>
                <td onclick="event.stopPropagation();">
                    <div class="btn-group">
                        <a th:href="@{/cards/edit/{id}(id=${card.id})}" class="btn btn-info btn-small">수정</a>
                        <form th:action="@{/cards/delete/{id}(id=${card.id})}" method="post" class="delete-form"
                              onsubmit="return confirm('정말 삭제하시겠습니까?');">
                            <button type="submit" class="btn btn-danger btn-small">삭제</button>
                        </form>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>

        <div th:if="${cards.isEmpty()}" class="empty-state">
            <h3>등록된 명함이 없습니다</h3>
            <p>명함을 직접 추가하거나 엑셀 파일을 업로드하세요.</p>
        </div>
    </div>

    <!-- 페이징 -->
    <div th:if="${totalPages > 1}" style="margin-top: 30px; text-align: center;">
        <div style="display: inline-flex; gap: 5px; align-items: center;">
            <!-- 이전 페이지 -->
            <a th:if="${hasPrev}"
               th:href="@{/cards/list(category=${selectedCategory}, keyword=${keyword}, searchField=${searchField}, sortBy=${sortBy}, page=${currentPage - 1})}"
               class="btn btn-secondary btn-small">이전</a>
            <span th:unless="${hasPrev}" class="btn btn-secondary btn-small" style="opacity: 0.5; cursor: not-allowed;">이전</span>

            <!-- 페이지 번호 -->
            <span th:each="pageNum : ${#numbers.sequence(startPage, endPage)}">
                <a th:if="${pageNum != currentPage}"
                   th:href="@{/cards/list(category=${selectedCategory}, keyword=${keyword}, searchField=${searchField}, sortBy=${sortBy}, page=${pageNum})}"
                   class="btn btn-secondary btn-small"
                   th:text="${pageNum}">1</a>
                <span th:if="${pageNum == currentPage}"
                      class="btn btn-primary btn-small"
                      th:text="${pageNum}">1</span>
            </span>

            <!-- 다음 페이지 -->
            <a th:if="${hasNext}"
               th:href="@{/cards/list(category=${selectedCategory}, keyword=${keyword}, searchField=${searchField}, sortBy=${sortBy}, page=${currentPage + 1})}"
               class="btn btn-secondary btn-small">다음</a>
            <span th:unless="${hasNext}" class="btn btn-secondary btn-small" style="opacity: 0.5; cursor: not-allowed;">다음</span>
        </div>

        <div style="margin-top: 10px; color: #666; font-size: 14px;">
            <span th:text="${currentPage}">1</span> / <span th:text="${totalPages}">1</span> 페이지
        </div>
    </div>
</div>

<!-- 이메일 다운로드 모달 -->
<div id="emailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>이메일 다운로드 설정</h2>
            <button class="modal-close" onclick="closeEmailModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="emailDownloadForm" th:action="@{/cards/download-emails}" method="get">
                <input type="hidden" name="category" th:value="${selectedCategory}">
                <input type="hidden" name="keyword" th:value="${keyword}">
                <input type="hidden" name="searchField" th:value="${searchField}">
                <input type="hidden" name="sortBy" th:value="${sortBy}">

                <div class="form-group">
                    <label>제외할 회사명 (콤마로 구분)</label>
                    <input type="text" name="excludeCompanies"
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <small style="display: block; margin-top: 5px; color: #666;">입력한 회사명을 포함하는 명함은 제외됩니다.</small>
                </div>

                <div class="form-group">
                    <label class="checkbox-group">
                        <input type="checkbox" name="semicolon" value="true">
                        <span>이메일 뒤에 세미콜론(;) 추가</span>
                    </label>
                </div>

                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" onclick="closeEmailModal()">취소</button>
                    <button type="submit" class="btn btn-success">다운로드</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function goToDetail(row) {
        const cardId = row.getAttribute('data-id');
        window.location.href = '/cards/' + cardId;
    }

    function changeSortBy() {
        const sortBy = document.getElementById('sortBySelect').value;
        const url = new URL(window.location.href);
        url.searchParams.set('sortBy', sortBy);
        url.searchParams.set('page', '1'); // 정렬 변경 시 첫 페이지로
        window.location.href = url.toString();
    }

    function showEmailDownloadModal() {
        document.getElementById('emailModal').classList.add('active');
    }

    function closeEmailModal() {
        document.getElementById('emailModal').classList.remove('active');
    }

    // 모달 외부 클릭 시 닫기
    window.onclick = function(event) {
        const modal = document.getElementById('emailModal');
        if (event.target === modal) {
            closeEmailModal();
        }
    }
</script>
</body>
</html>